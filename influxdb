#!/bin/bash

set -e

echo "Téléchargement d'InfluxDB v1.8.10 (ARMv7)..."
wget https://dl.influxdata.com/influxdb/releases/influxdb-1.8.10_linux_armhf.tar.gz

echo "Extraction..."
tar xvf influxdb-1.8.10_linux_armhf.tar.gz

echo "Installation dans /usr/local/bin..."
sudo cp influxdb-1.8.10-1/influxd /usr/local/bin/
sudo cp influxdb-1.8.10-1/influx /usr/local/bin/
sudo chmod +x /usr/local/bin/influx*

echo "Création du répertoire de données et config..."
sudo mkdir -p /var/lib/influxdb
sudo mkdir -p /etc/influxdb

echo "Copie du fichier de configuration par défaut..."
sudo cp influxdb-1.8.10-1/etc/influxdb.conf /etc/influxdb/influxdb.conf

echo "Création du service systemd..."
sudo tee /etc/systemd/system/influxdb.service > /dev/null <<EOF
[Unit]
Description=InfluxDB 1.8 Time Series Database
After=network.target

[Service]
ExecStart=/usr/local/bin/influxd -config /etc/influxdb/influxdb.conf
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

echo "Activation du service..."
sudo systemctl daemon-reload
sudo systemctl enable influxdb
sudo systemctl start influxdb

echo "Vérification du statut du service..."
sudo systemctl status influxdb --no-pager
