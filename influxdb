#!/bin/bash

set -e

ARCHIVE="influxdb-1.8.10_linux_armhf.tar.gz"
URL="https://dl.influxdata.com/influxdb/releases/$ARCHIVE"

echo "Téléchargement d'InfluxDB v1.8.10 (ARMv7)..."
wget -q "$URL"

echo "Extraction..."
tar -xzf "$ARCHIVE"

# Trouver le dossier extrait (par précaution)
FOLDER=$(tar -tzf "$ARCHIVE" | head -1 | cut -f1 -d"/")

echo "Dossier extrait : $FOLDER"

echo "Copie des exécutables dans /usr/local/bin..."
sudo cp "$FOLDER/usr/bin/influxd" /usr/local/bin/
sudo cp "$FOLDER/usr/bin/influx" /usr/local/bin/
sudo chmod +x /usr/local/bin/influx*

echo "Création des répertoires de données et configuration..."
sudo mkdir -p /var/lib/influxdb
sudo mkdir -p /etc/influxdb

echo "Copie du fichier de configuration par défaut..."
sudo cp "$FOLDER/etc/influxdb/influxdb.conf" /etc/influxdb/influxdb.conf

echo "Création du service systemd..."
sudo tee /etc/systemd/system/influxdb.service > /dev/null <<EOF
[Unit]
Description=InfluxDB 1.8 Time Series Database
After=network.target

[Service]
ExecStart=/usr/local/bin/influxd -config /etc/influxdb/influxdb.conf
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

echo "Activation du service InfluxDB..."
sudo systemctl daemon-reload
sudo systemctl enable influxdb
sudo systemctl start influxdb

echo "InfluxDB est installé. Statut du service :"
sudo systemctl status influxdb --no-pager
